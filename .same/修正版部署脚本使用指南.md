# Ubuntu 22.04 修正版部署脚本使用指南

## 🎯 快速开始

### 第一步：下载脚本
```bash
# 方法1: 直接下载脚本文件
wget https://raw.githubusercontent.com/your-repo/Ubuntu22.04一键部署脚本-修正版.sh
chmod +x Ubuntu22.04一键部署脚本-修正版.sh

# 方法2: 克隆整个项目
git clone https://github.com/your-username/zhuhai-youmei-deploy.git
cd zhuhai-youmei-deploy
chmod +x .same/Ubuntu22.04一键部署脚本-修正版.sh
```

### 第二步：运行脚本
```bash
# 执行完整部署
./Ubuntu22.04一键部署脚本-修正版.sh

# 或者先检查系统环境
./Ubuntu22.04一键部署脚本-修正版.sh check
```

### 第三步：按提示输入配置
脚本会引导您输入必要的配置信息：

```bash
请输入域名 (例如: example.com，留空使用IP):
请输入管理员邮箱 (用于SSL证书):
请设置数据库密码 (至少8位):
请设置Redis密码 (至少8位):
请设置Django管理员密码 (至少8位):
```

---

## 📋 配置信息详解

### 🌐 域名配置
```bash
# 示例1: 使用域名
请输入域名: youmei.com

# 示例2: 使用IP地址（留空自动获取）
请输入域名: [直接回车，自动使用服务器IP]
```

**说明：**
- 如果有域名，输入完整域名（不含http://）
- 如果没有域名，直接回车使用服务器IP
- 域名将用于SSL证书申请和Nginx配置

### 📧 邮箱配置
```bash
# 示例
请输入管理员邮箱: admin@youmei.com
```

**说明：**
- 用于SSL证书申请
- 用于Django超级用户账号
- 建议使用真实邮箱地址

### 🔐 密码配置
```bash
# 数据库密码示例
请设置数据库密码: MySecureDb123!

# Redis密码示例
请设置Redis密码: MySecureRedis456!

# Django管理员密码示例
请设置Django管理员密码: MySecureAdmin789!
```

**密码要求：**
- 至少8位字符
- 建议包含大小写字母、数字和特殊字符
- 避免使用简单密码如"password"、"123456"

---

## 🔧 脚本执行选项

### 完整部署
```bash
./Ubuntu22.04一键部署脚本-修正版.sh deploy
# 或直接运行
./Ubuntu22.04一键部署脚本-修正版.sh
```

### 系统检查
```bash
./Ubuntu22.04一键部署脚本-修正版.sh check
```
检查内容：
- Ubuntu版本验证
- 内存和磁盘空间检查
- 用户权限验证

### 系统更新
```bash
./Ubuntu22.04一键部署脚本-修正版.sh update
```
仅执行系统包更新，不进行部署。

### 部署验证
```bash
./Ubuntu22.04一键部署脚本-修正版.sh verify
```
验证已部署的服务状态。

---

## ⏱️ 部署时间估算

| 阶段 | 预计时间 | 说明 |
|------|----------|------|
| 系统检查 | 1分钟 | 验证环境和收集配置 |
| 系统更新 | 3-5分钟 | 更新Ubuntu包 |
| 软件安装 | 5-10分钟 | Node.js, Python, PostgreSQL等 |
| 项目部署 | 3-5分钟 | Django后端和Vue前端 |
| 服务配置 | 2-3分钟 | Nginx, Supervisor, SSL |
| **总计** | **15-25分钟** | 取决于网络速度 |

---

## 📁 部署结果

### 目录结构
```
/var/www/zhuhai-youmei/
└── ym-cosmetics/                 # 项目根目录
    ├── backend/                  # Django后端
    │   ├── zhuhai_youmei/       # Django项目
    │   ├── venv/                # Python虚拟环境
    │   ├── media/               # 媒体文件
    │   ├── staticfiles/         # 静态文件
    │   └── .env                 # 环境配置
    ├── frontend/                 # Vue前端
    │   ├── src/                 # 源代码
    │   ├── dist/                # 构建输出
    │   └── package.json         # 依赖配置
    ├── logs/                     # 日志文件
    ├── backups/                  # 备份文件
    └── scripts/                  # 管理脚本
```

### 访问地址
```bash
# 前端网站
https://youmei.com/

# 管理后台
https://youmei.com/api/admin/
用户名: admin
密码: [您设置的管理员密码]

# API接口
https://youmei.com/api/
健康检查: https://youmei.com/api/health/
```

### 服务端口
```bash
# Nginx (对外)
HTTP: 80
HTTPS: 443

# Django (内部)
Gunicorn: 127.0.0.1:8000

# 数据库 (内部)
PostgreSQL: 127.0.0.1:5432
Redis: 127.0.0.1:6379
```

---

## 🛠️ 部署后管理

### 常用管理命令
```bash
# 查看系统状态
/var/www/zhuhai-youmei/ym-cosmetics/scripts/status.sh

# 查看服务日志
/var/www/zhuhai-youmei/ym-cosmetics/scripts/logs.sh all

# 更新部署
/var/www/zhuhai-youmei/ym-cosmetics/scripts/deploy.sh

# 数据备份
/var/www/zhuhai-youmei/ym-cosmetics/scripts/backup.sh
```

### 服务管理
```bash
# 重启后端服务
sudo supervisorctl restart zhuhai-youmei-backend

# 重启Web服务器
sudo systemctl restart nginx

# 重启数据库
sudo systemctl restart postgresql

# 重启缓存
sudo systemctl restart redis-server
```

### Django管理
```bash
# 进入后端目录
cd /var/www/zhuhai-youmei/ym-cosmetics/backend

# 激活虚拟环境
source venv/bin/activate

# 数据库迁移
python3 manage.py migrate

# 收集静态文件
python3 manage.py collectstatic --noinput

# 创建超级用户
python3 manage.py createsuperuser

# Django Shell
python3 manage.py shell
```

---

## 🚨 故障排除

### 1. 脚本权限问题
```bash
# 错误: Permission denied
chmod +x Ubuntu22.04一键部署脚本-修正版.sh

# 如果仍有问题，检查文件完整性
ls -la Ubuntu22.04一键部署脚本-修正版.sh
```

### 2. 系统检查失败
```bash
# 内存不足
free -h  # 检查内存
# 建议: 升级服务器配置或关闭不必要服务

# 磁盘空间不足
df -h    # 检查磁盘
# 建议: 清理临时文件或升级存储
```

### 3. 网络连接问题
```bash
# 测试网络连接
ping -c 3 google.com
curl -I https://deb.nodesource.com/

# 如果网络有问题，检查防火墙和DNS
```

### 4. 软件安装失败
```bash
# 手动更新软件源
sudo apt update
sudo apt upgrade -y

# 清理APT缓存
sudo apt clean
sudo apt autoremove

# 重新运行脚本
./Ubuntu22.04一键部署脚本-修正版.sh
```

### 5. 服务启动失败
```bash
# 检查后端服务
sudo supervisorctl status zhuhai-youmei-backend
sudo supervisorctl tail -f zhuhai-youmei-backend

# 检查Nginx配置
sudo nginx -t
sudo systemctl status nginx

# 检查数据库
sudo systemctl status postgresql
sudo -u postgres psql -l
```

### 6. SSL证书申请失败
```bash
# 检查域名解析
nslookup youmei.com

# 手动申请证书
sudo certbot --nginx -d youmei.com -d www.youmei.com

# 检查防火墙
sudo ufw status
```

---

## 🔄 更新和维护

### 定期维护任务

#### 每日
```bash
# 查看系统状态
/var/www/zhuhai-youmei/ym-cosmetics/scripts/status.sh

# 检查服务日志
/var/www/zhuhai-youmei/ym-cosmetics/scripts/logs.sh all
```

#### 每周
```bash
# 系统更新
sudo apt update && sudo apt upgrade -y

# 数据备份
/var/www/zhuhai-youmei/ym-cosmetics/scripts/backup.sh

# 清理日志
sudo journalctl --vacuum-time=7d
```

#### 每月
```bash
# SSL证书续期检查
sudo certbot certificates
sudo certbot renew --dry-run

# 清理旧备份
find /var/www/zhuhai-youmei/ym-cosmetics/backups/ -mtime +30 -delete

# 数据库维护
sudo -u postgres psql -d zhuhai_youmei -c "VACUUM ANALYZE;"
```

### 代码更新流程
```bash
# 1. 备份当前版本
/var/www/zhuhai-youmei/ym-cosmetics/scripts/backup.sh

# 2. 更新代码 (如果使用Git)
cd /var/www/zhuhai-youmei/ym-cosmetics/backend
git pull origin main

cd /var/www/zhuhai-youmei/ym-cosmetics/frontend
git pull origin main

# 3. 执行更新部署
/var/www/zhuhai-youmei/ym-cosmetics/scripts/deploy.sh

# 4. 验证服务状态
/var/www/zhuhai-youmei/ym-cosmetics/scripts/status.sh
```

---

## 📞 获取帮助

### 查看脚本帮助
```bash
./Ubuntu22.04一键部署脚本-修正版.sh --help
```

### 常用诊断命令
```bash
# 系统信息
uname -a
lsb_release -a
free -h
df -h

# 服务状态
systemctl status nginx
systemctl status postgresql
systemctl status redis-server
supervisorctl status

# 网络状态
netstat -tlnp | grep -E ':80|:443|:8000|:5432|:6379'
```

### 日志文件位置
```bash
# 应用日志
/var/www/zhuhai-youmei/ym-cosmetics/logs/

# 系统日志
/var/log/nginx/
/var/log/postgresql/
journalctl -u nginx
journalctl -u postgresql
```

---

🎉 **恭喜！您已经掌握了修正版部署脚本的完整使用方法！**

如果在使用过程中遇到任何问题，请参考故障排除部分或查看相关日志文件。脚本已经过优化，能够在大多数Ubuntu 22.04环境中稳定运行。
