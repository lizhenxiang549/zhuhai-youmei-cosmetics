# 珠海优美官网 - 完整部署流程指南

## 🎯 部署概览

本指南将帮助您完整部署珠海优美化妆品官网，包括Django后端API和Vue前端应用的整合部署。

### 系统架构
```
用户请求 → Nginx → Vue前端 (SPA)
          ↓
       Django后端 (API) → PostgreSQL数据库
          ↓
       Redis缓存 (可选)
```

---

## 🛒 1. 服务器选择方案

### 方案一: 单服务器部署（推荐中小企业）
```bash
# 阿里云ECS配置
- 实例规格: ecs.c6.xlarge (4核8GB)
- 操作系统: Ubuntu 22.04 LTS
- 带宽: 10Mbps
- 存储: 100GB SSD
- 费用: 约400-600元/月

# 架构：前端 + 后端 + 数据库在同一台服务器
```

### 方案二: 分离部署（推荐大型企业）
```bash
# Web服务器 (前端)
- 实例规格: ecs.t6-c1m2.large (2核4GB)
- 费用: 约150-250元/月

# API服务器 (后端)
- 实例规格: ecs.c6.large (2核4GB)
- 费用: 约200-300元/月

# 数据库服务器 (RDS)
- PostgreSQL 15, 2核4GB
- 费用: 约300-500元/月

# 总费用: 约650-1050元/月
```

---

## 🚀 2. 单服务器完整部署流程

### 2.1 服务器初始化
```bash
# 连接服务器
ssh root@your-server-ip

# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装基础工具
sudo apt install -y curl wget git unzip build-essential software-properties-common nginx postgresql postgresql-contrib redis-server supervisor

# 创建用户
sudo adduser deploy
sudo usermod -aG sudo deploy
```

### 2.2 环境配置
```bash
# 切换到deploy用户
su - deploy

# 安装Node.js 20
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装Bun
curl -fsSL https://bun.sh/install | bash
source ~/.bashrc

# 安装Python 3.11
sudo add-apt-repository ppa:deadsnakes/ppa
sudo apt update
sudo apt install -y python3.11 python3.11-venv python3.11-dev
curl https://bootstrap.pypa.io/get-pip.py | python3.11
```

### 2.3 数据库配置
```bash
# 配置PostgreSQL
sudo -u postgres psql

-- 创建数据库和用户
CREATE DATABASE zhuhai_youmei;
CREATE USER youmei_user WITH PASSWORD 'your_strong_password';
GRANT ALL PRIVILEGES ON DATABASE zhuhai_youmei TO youmei_user;
\q

# 配置Redis
sudo nano /etc/redis/redis.conf
# 设置密码: requirepass your_redis_password
sudo systemctl restart redis-server
```

### 2.4 项目目录结构
```bash
# 创建项目总目录
sudo mkdir -p /var/www/zhuhai-youmei
sudo chown -R deploy:deploy /var/www/zhuhai-youmei
cd /var/www/zhuhai-youmei

# 目录结构
/var/www/zhuhai-youmei/
├── frontend/          # Vue前端项目
├── backend/           # Django后端项目
├── nginx/            # Nginx配置文件
├── scripts/          # 部署脚本
└── logs/            # 日志文件
```

---

## 📦 3. 后端部署

### 3.1 部署Django项目
```bash
cd /var/www/zhuhai-youmei

# 下载后端代码
git clone https://github.com/your-username/zhuhai-youmei-backend.git backend
cd backend

# 创建虚拟环境
python3.11 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

### 3.2 Django配置
```bash
# 创建.env文件
nano .env
```

```env
DEBUG=False
SECRET_KEY=your-very-long-secret-key-here
ALLOWED_HOSTS=your-domain.com,www.your-domain.com,api.your-domain.com

DB_NAME=zhuhai_youmei
DB_USER=youmei_user
DB_PASSWORD=your_strong_password
DB_HOST=localhost
DB_PORT=5432

REDIS_URL=redis://localhost:6379/0
REDIS_PASSWORD=your_redis_password

CORS_ALLOWED_ORIGINS=https://your-domain.com,https://www.your-domain.com
```

### 3.3 数据库迁移
```bash
# 执行迁移
python manage.py makemigrations
python manage.py migrate

# 创建超级用户
python manage.py createsuperuser

# 收集静态文件
python manage.py collectstatic --noinput
```

### 3.4 Gunicorn配置
```bash
# 安装Gunicorn
pip install gunicorn

# 创建Gunicorn配置
nano gunicorn.conf.py
```

```python
bind = "127.0.0.1:8000"
workers = 3
worker_class = "sync"
timeout = 30
keepalive = 2
max_requests = 1000
preload_app = True
```

### 3.5 Supervisor配置
```bash
sudo nano /etc/supervisor/conf.d/zhuhai-youmei-backend.conf
```

```ini
[program:zhuhai-youmei-backend]
command=/var/www/zhuhai-youmei/backend/venv/bin/gunicorn --config gunicorn.conf.py zhuhai_youmei.wsgi:application
directory=/var/www/zhuhai-youmei/backend
user=deploy
autostart=true
autorestart=true
stdout_logfile=/var/www/zhuhai-youmei/logs/backend.log
stderr_logfile=/var/www/zhuhai-youmei/logs/backend_error.log
```

```bash
# 创建日志目录
mkdir -p /var/www/zhuhai-youmei/logs

# 启动后端服务
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start zhuhai-youmei-backend
```

---

## 🎨 4. 前端部署

### 4.1 部署Vue项目
```bash
cd /var/www/zhuhai-youmei

# 下载前端代码
git clone https://github.com/your-username/zhuhai-youmei-frontend.git frontend
cd frontend

# 安装依赖
bun install
```

### 4.2 配置API地址
```bash
# 创建生产环境配置
nano .env.production
```

```env
VITE_API_BASE_URL=https://api.your-domain.com
VITE_APP_TITLE=珠海优美化妆品有限公司
```

### 4.3 构建前端
```bash
# 构建生产版本
bun run build

# 验证构建结果
ls -la dist/
```

---

## 🌐 5. Nginx完整配置

### 5.1 主配置文件
```bash
sudo nano /etc/nginx/sites-available/zhuhai-youmei
```

```nginx
# 前端主站
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    # SSL配置
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # 安全headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;

    # 前端静态文件
    root /var/www/zhuhai-youmei/frontend/dist;
    index index.html;

    # Vue Router history模式
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 静态资源缓存
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
}

# API后端
server {
    listen 80;
    server_name api.your-domain.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.your-domain.com;

    # SSL配置
    ssl_certificate /etc/letsencrypt/live/api.your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.your-domain.com/privkey.pem;

    # 客户端上传大小限制
    client_max_body_size 100M;

    # Django静态文件
    location /static/ {
        alias /var/www/zhuhai-youmei/backend/staticfiles/;
        expires 1y;
    }

    # Django媒体文件
    location /media/ {
        alias /var/www/zhuhai-youmei/backend/media/;
        expires 1y;
    }

    # API代理
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # CORS headers (如果需要)
        add_header Access-Control-Allow-Origin "https://your-domain.com" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization" always;

        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
}
```

### 5.2 启用配置
```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/zhuhai-youmei /etc/nginx/sites-enabled/
sudo rm /etc/nginx/sites-enabled/default

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

---

## 🔒 6. SSL证书配置

### 6.1 申请证书
```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 为主域名申请证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 为API域名申请证书
sudo certbot --nginx -d api.your-domain.com

# 设置自动续期
echo "0 2 1 * * /usr/bin/certbot renew --quiet && /usr/bin/systemctl reload nginx" | sudo crontab -
```

---

## 🔄 7. 自动化部署脚本

### 7.1 完整部署脚本
```bash
nano /var/www/zhuhai-youmei/scripts/deploy.sh
```

```bash
#!/bin/bash

echo "🚀 开始部署珠海优美官网..."

PROJECT_ROOT="/var/www/zhuhai-youmei"
BACKEND_DIR="$PROJECT_ROOT/backend"
FRONTEND_DIR="$PROJECT_ROOT/frontend"

# 检查是否有更新
cd $PROJECT_ROOT

echo "📦 更新后端代码..."
cd $BACKEND_DIR
git pull origin main

echo "📦 更新前端代码..."
cd $FRONTEND_DIR
git pull origin main

# 后端部署
echo "🔧 部署后端..."
cd $BACKEND_DIR
source venv/bin/activate
pip install -r requirements.txt
python manage.py migrate
python manage.py collectstatic --noinput
sudo supervisorctl restart zhuhai-youmei-backend

# 前端部署
echo "🎨 部署前端..."
cd $FRONTEND_DIR
bun install
bun run build

# 重启服务
echo "🔄 重启服务..."
sudo systemctl reload nginx

# 检查服务状态
echo "✅ 检查服务状态..."
sudo supervisorctl status zhuhai-youmei-backend
sudo systemctl status nginx

echo "🎉 部署完成！"
echo "🌐 前端地址: https://your-domain.com"
echo "🔗 API地址: https://api.your-domain.com"
echo "⚙️ 管理后台: https://api.your-domain.com/admin/"
```

```bash
chmod +x /var/www/zhuhai-youmei/scripts/deploy.sh
```

### 7.2 快速重启脚本
```bash
nano /var/www/zhuhai-youmei/scripts/restart.sh
```

```bash
#!/bin/bash

echo "🔄 重启所有服务..."

# 重启后端
sudo supervisorctl restart zhuhai-youmei-backend

# 重启Nginx
sudo systemctl restart nginx

# 重启数据库和缓存
sudo systemctl restart postgresql
sudo systemctl restart redis-server

echo "✅ 所有服务已重启"
```

---

## 📊 8. 监控和日志

### 8.1 日志聚合脚本
```bash
nano /var/www/zhuhai-youmei/scripts/logs.sh
```

```bash
#!/bin/bash

case "$1" in
    backend)
        tail -f /var/www/zhuhai-youmei/logs/backend.log
        ;;
    backend-error)
        tail -f /var/www/zhuhai-youmei/logs/backend_error.log
        ;;
    nginx-access)
        sudo tail -f /var/log/nginx/access.log
        ;;
    nginx-error)
        sudo tail -f /var/log/nginx/error.log
        ;;
    postgres)
        sudo tail -f /var/log/postgresql/postgresql-15-main.log
        ;;
    all)
        echo "=== Backend Logs ==="
        tail -n 20 /var/www/zhuhai-youmei/logs/backend.log
        echo -e "\n=== Nginx Logs ==="
        sudo tail -n 20 /var/log/nginx/error.log
        ;;
    *)
        echo "Usage: $0 {backend|backend-error|nginx-access|nginx-error|postgres|all}"
        ;;
esac
```

### 8.2 系统监控脚本
```bash
nano /var/www/zhuhai-youmei/scripts/monitor.sh
```

```bash
#!/bin/bash

echo "📊 系统状态监控"
echo "=================="

# 系统资源
echo "💾 内存使用:"
free -h

echo -e "\n💽 磁盘使用:"
df -h

echo -e "\n🔥 CPU使用:"
top -b -n1 | grep "Cpu(s)"

# 服务状态
echo -e "\n🚀 服务状态:"
echo "Nginx: $(sudo systemctl is-active nginx)"
echo "PostgreSQL: $(sudo systemctl is-active postgresql)"
echo "Redis: $(sudo systemctl is-active redis-server)"
echo "Backend: $(sudo supervisorctl status zhuhai-youmei-backend | awk '{print $2}')"

# 端口监听
echo -e "\n🌐 端口监听:"
sudo netstat -tlnp | grep -E ':80|:443|:8000|:5432|:6379'

# 最近日志
echo -e "\n📝 最近错误 (最近10条):"
sudo tail -n 10 /var/log/nginx/error.log | grep -E "error|warn" || echo "无错误日志"
```

---

## 🔧 9. 备份策略

### 9.1 完整备份脚本
```bash
nano /var/www/zhuhai-youmei/scripts/backup.sh
```

```bash
#!/bin/bash

BACKUP_DIR="/home/deploy/backups"
DATE=$(date +%Y%m%d_%H%M%S)
PROJECT_ROOT="/var/www/zhuhai-youmei"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 数据库备份
echo "🗄️ 备份数据库..."
pg_dump -h localhost -U youmei_user -d zhuhai_youmei > $BACKUP_DIR/db_backup_$DATE.sql

# 媒体文件备份
echo "📁 备份媒体文件..."
tar -czf $BACKUP_DIR/media_backup_$DATE.tar.gz -C $PROJECT_ROOT/backend media/

# 配置文件备份
echo "⚙️ 备份配置文件..."
tar -czf $BACKUP_DIR/config_backup_$DATE.tar.gz -C / etc/nginx/sites-available/zhuhai-youmei etc/supervisor/conf.d/zhuhai-youmei-backend.conf $PROJECT_ROOT/backend/.env

# 代码备份 (可选)
echo "💾 备份代码..."
tar -czf $BACKUP_DIR/code_backup_$DATE.tar.gz --exclude='*/node_modules' --exclude='*/venv' --exclude='*/dist' -C /var/www zhuhai-youmei

# 清理旧备份 (保留7天)
find $BACKUP_DIR -name "*backup_*" -mtime +7 -delete

echo "✅ 备份完成到: $BACKUP_DIR"
echo "📁 数据库: db_backup_$DATE.sql"
echo "📁 媒体文件: media_backup_$DATE.tar.gz"
echo "📁 配置文件: config_backup_$DATE.tar.gz"
echo "📁 代码: code_backup_$DATE.tar.gz"
```

### 9.2 设置定期备份
```bash
# 设置每日凌晨2点备份
crontab -e
# 添加：0 2 * * * /var/www/zhuhai-youmei/scripts/backup.sh
```

---

## 🔐 10. 安全配置

### 10.1 防火墙配置
```bash
# 配置UFW
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
sudo ufw deny 8000  # 禁止直接访问Django端口
sudo ufw deny 5432  # 禁止外部访问数据库
sudo ufw enable

# 查看状态
sudo ufw status verbose
```

### 10.2 Fail2ban配置
```bash
# 安装Fail2ban
sudo apt install -y fail2ban

# 配置
sudo nano /etc/fail2ban/jail.local
```

```ini
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 3

[sshd]
enabled = true

[nginx-http-auth]
enabled = true

[nginx-limit-req]
enabled = true
```

---

## 📋 11. 维护清单

### 11.1 每日检查
```bash
# 运行监控脚本
/var/www/zhuhai-youmei/scripts/monitor.sh

# 检查备份
ls -la /home/deploy/backups/

# 检查日志
/var/www/zhuhai-youmei/scripts/logs.sh all
```

### 11.2 每周维护
```bash
# 系统更新
sudo apt update && sudo apt upgrade -y

# 清理日志
sudo journalctl --vacuum-time=7d

# 清理备份
find /home/deploy/backups -mtime +30 -delete
```

### 11.3 每月维护
```bash
# 更新SSL证书
sudo certbot renew

# 数据库维护
sudo -u postgres psql -d zhuhai_youmei -c "VACUUM ANALYZE;"

# 检查磁盘使用
df -h
```

---

## 🚀 12. 性能优化

### 12.1 数据库优化
```sql
-- PostgreSQL优化配置
-- 编辑 /etc/postgresql/15/main/postgresql.conf

shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
```

### 12.2 Nginx优化
```nginx
# 编辑 /etc/nginx/nginx.conf

worker_processes auto;
worker_connections 1024;
keepalive_timeout 65;

# 启用HTTP/2
server {
    listen 443 ssl http2;
    # ...
}
```

---

## 📞 13. 故障排除

### 13.1 常见问题
```bash
# 网站无法访问
sudo systemctl status nginx
sudo nginx -t

# API不响应
sudo supervisorctl status zhuhai-youmei-backend
tail -f /var/www/zhuhai-youmei/logs/backend_error.log

# 数据库连接错误
sudo systemctl status postgresql
sudo -u postgres psql -l

# SSL证书问题
sudo certbot certificates
sudo nginx -t
```

### 13.2 应急恢复
```bash
# 快速回滚
git log --oneline -10  # 查看提交历史
git checkout <commit-hash>  # 回滚到指定版本
/var/www/zhuhai-youmei/scripts/deploy.sh

# 数据库恢复
sudo -u postgres psql -d zhuhai_youmei < backup.sql
```

---

## 🎉 部署完成检查清单

### ✅ 前端检查
- [ ] https://your-domain.com 可以正常访问
- [ ] 所有页面路由正常工作
- [ ] 响应式设计在各设备正常显示
- [ ] 静态资源加载正常

### ✅ 后端检查
- [ ] https://api.your-domain.com/admin/ 管理后台可访问
- [ ] API接口返回正确数据
- [ ] 数据库连接正常
- [ ] 文件上传功能正常

### ✅ 系统检查
- [ ] SSL证书有效且自动续期设置完成
- [ ] 防火墙规则配置正确
- [ ] 备份脚本运行正常
- [ ] 监控脚本可以查看系统状态

---

🎉 **恭喜！珠海优美化妆品官网已完整部署成功！**

**访问地址:**
- 🌐 官网首页: https://your-domain.com
- 🔗 API接口: https://api.your-domain.com
- ⚙️ 管理后台: https://api.your-domain.com/admin/

**管理命令:**
- 部署更新: `/var/www/zhuhai-youmei/scripts/deploy.sh`
- 重启服务: `/var/www/zhuhai-youmei/scripts/restart.sh`
- 查看日志: `/var/www/zhuhai-youmei/scripts/logs.sh all`
- 系统监控: `/var/www/zhuhai-youmei/scripts/monitor.sh`
- 数据备份: `/var/www/zhuhai-youmei/scripts/backup.sh`
