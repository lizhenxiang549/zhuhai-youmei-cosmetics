# 珠海优美官网 - 阿里云Ubuntu 22.04部署指南

## 📋 部署概览

本指南将帮助您在阿里云Ubuntu 22.04服务器上部署珠海优美化妆品官网（Vue 3 + TypeScript + Vite项目）。

### 项目架构
- **前端**: Vue 3 + TypeScript + Vite
- **包管理器**: Bun
- **Web服务器**: Nginx
- **进程管理**: PM2
- **SSL证书**: Let's Encrypt

---

## 🛒 1. 阿里云服务器购买与配置

### 1.1 购买ECS实例
```bash
# 推荐配置
- 实例规格: ecs.t6-c1m2.large (2核4GB) 或更高
- 操作系统: Ubuntu 22.04 LTS
- 带宽: 5Mbps 或更高
- 存储: 40GB SSD 或更高
- 安全组: 开放 22, 80, 443 端口
```

### 1.2 初始安全设置
```bash
# 连接服务器
ssh root@your-server-ip

# 更新系统
sudo apt update && sudo apt upgrade -y

# 创建非root用户
sudo adduser deploy
sudo usermod -aG sudo deploy

# 配置SSH密钥登录（推荐）
# 在本地生成密钥对
ssh-keygen -t rsa -b 4096 -C "your-email@example.com"

# 复制公钥到服务器
ssh-copy-id deploy@your-server-ip
```

---

## 🔧 2. 服务器环境准备

### 2.1 安装基础工具
```bash
# 切换到deploy用户
su - deploy

# 安装必要工具
sudo apt install -y curl wget git unzip build-essential

# 安装 Node.js (使用NodeSource仓库)
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version  # 应该显示 v20.x.x
npm --version
```

### 2.2 安装Bun
```bash
# 安装Bun包管理器
curl -fsSL https://bun.sh/install | bash

# 重新加载shell配置
source ~/.bashrc

# 验证安装
bun --version
```

### 2.3 安装Nginx
```bash
# 安装Nginx
sudo apt install -y nginx

# 启动并设置开机自启
sudo systemctl start nginx
sudo systemctl enable nginx

# 检查状态
sudo systemctl status nginx
```

### 2.4 安装PM2进程管理器
```bash
# 全局安装PM2
sudo npm install -g pm2

# 设置PM2开机自启
pm2 startup
sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u deploy --hp /home/deploy
```

---

## 📦 3. 项目部署

### 3.1 创建项目目录
```bash
# 创建项目目录
sudo mkdir -p /var/www/zhuhai-youmei
sudo chown -R deploy:deploy /var/www/zhuhai-youmei
cd /var/www/zhuhai-youmei
```

### 3.2 上传项目文件

#### 方法1: 使用Git（推荐）
```bash
# 如果有Git仓库
git clone https://github.com/your-username/msd-style-cosmetics.git .
cd frontend
```

#### 方法2: 使用SCP上传
```bash
# 在本地执行（打包项目）
cd msd-style-cosmetics/frontend
tar -czf project.tar.gz .

# 上传到服务器
scp project.tar.gz deploy@your-server-ip:/var/www/zhuhai-youmei/

# 在服务器解压
cd /var/www/zhuhai-youmei
tar -xzf project.tar.gz
rm project.tar.gz
```

### 3.3 安装依赖和构建
```bash
cd /var/www/zhuhai-youmei

# 安装项目依赖
bun install

# 构建生产版本
bun run build

# 检查构建结果
ls -la dist/
```

---

## 🌐 4. Nginx配置

### 4.1 创建站点配置
```bash
# 创建Nginx配置文件
sudo nano /etc/nginx/sites-available/zhuhai-youmei
```

### 4.2 Nginx配置内容
```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    # SSL配置（稍后配置证书）
    # ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # 安全headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

    # 网站根目录
    root /var/www/zhuhai-youmei/dist;
    index index.html;

    # 处理Vue Router的history模式
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 静态资源缓存
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 压缩配置
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss;
}
```

### 4.3 启用站点配置
```bash
# 创建软链接启用站点
sudo ln -s /etc/nginx/sites-available/zhuhai-youmei /etc/nginx/sites-enabled/

# 删除默认配置
sudo rm /etc/nginx/sites-enabled/default

# 测试Nginx配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

---

## 🔒 5. SSL证书配置

### 5.1 安装Certbot
```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com
```

### 5.2 更新Nginx配置
```bash
# 编辑配置文件，取消SSL配置的注释
sudo nano /etc/nginx/sites-available/zhuhai-youmei

# 重启Nginx
sudo systemctl restart nginx
```

### 5.3 设置证书自动续期
```bash
# 测试自动续期
sudo certbot renew --dry-run

# 添加cron任务
sudo crontab -e

# 添加以下行（每月1号凌晨2点检查续期）
0 2 1 * * /usr/bin/certbot renew --quiet && /usr/bin/systemctl reload nginx
```

---

## 🚀 6. PM2进程管理（可选 - 如果需要SSR）

### 6.1 创建PM2配置文件
```bash
cd /var/www/zhuhai-youmei
nano ecosystem.config.js
```

```javascript
module.exports = {
  apps: [{
    name: 'zhuhai-youmei',
    script: 'bun',
    args: 'run preview --host 0.0.0.0 --port 3000',
    cwd: '/var/www/zhuhai-youmei',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production'
    }
  }]
}
```

### 6.2 启动PM2
```bash
# 启动应用
pm2 start ecosystem.config.js

# 保存PM2配置
pm2 save

# 查看运行状态
pm2 status
pm2 logs
```

---

## 🔥 7. 防火墙配置

### 7.1 配置UFW防火墙
```bash
# 启用UFW
sudo ufw enable

# 允许SSH
sudo ufw allow ssh

# 允许HTTP和HTTPS
sudo ufw allow 'Nginx Full'

# 查看状态
sudo ufw status
```

### 7.2 阿里云安全组配置
```bash
# 在阿里云控制台配置安全组规则：
# - 入方向：允许 22/TCP (SSH)
# - 入方向：允许 80/TCP (HTTP)
# - 入方向：允许 443/TCP (HTTPS)
# - 出方向：允许全部
```

---

## 📊 8. 监控和日志

### 8.1 系统监控
```bash
# 安装htop
sudo apt install -y htop

# 查看系统资源
htop
df -h
free -h
```

### 8.2 日志管理
```bash
# Nginx日志位置
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# 系统日志
sudo journalctl -u nginx -f
```

### 8.3 设置日志轮转
```bash
# 编辑logrotate配置
sudo nano /etc/logrotate.d/nginx

# 确保包含以下内容：
/var/log/nginx/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        systemctl reload nginx
    endscript
}
```

---

## 🔄 9. 部署自动化脚本

### 9.1 创建部署脚本
```bash
nano /home/deploy/deploy.sh
```

```bash
#!/bin/bash

echo "🚀 开始部署珠海优美官网..."

# 项目目录
PROJECT_DIR="/var/www/zhuhai-youmei"

# 切换到项目目录
cd $PROJECT_DIR

# 拉取最新代码（如果使用Git）
echo "📦 更新代码..."
git pull origin main

# 安装依赖
echo "📋 安装依赖..."
bun install

# 构建项目
echo "🔨 构建项目..."
bun run build

# 重启Nginx
echo "🔄 重启Nginx..."
sudo systemctl restart nginx

# 检查服务状态
echo "✅ 检查服务状态..."
sudo systemctl status nginx --no-pager

echo "🎉 部署完成！"
echo "🌐 网站地址: https://your-domain.com"
```

### 9.2 设置脚本权限
```bash
chmod +x /home/deploy/deploy.sh

# 运行部署
./deploy.sh
```

---

## 🛠️ 10. 常见问题解决

### 10.1 权限问题
```bash
# 修复文件权限
sudo chown -R deploy:deploy /var/www/zhuhai-youmei
sudo chmod -R 755 /var/www/zhuhai-youmei
```

### 10.2 Nginx启动失败
```bash
# 检查配置语法
sudo nginx -t

# 查看错误日志
sudo journalctl -u nginx --no-pager
```

### 10.3 SSL证书问题
```bash
# 手动续期证书
sudo certbot renew

# 检查证书状态
sudo certbot certificates
```

### 10.4 端口占用
```bash
# 查看端口占用
sudo netstat -tulpn | grep :80
sudo netstat -tulpn | grep :443

# 杀死占用端口的进程
sudo pkill -f nginx
```

---

## 📋 11. 维护清单

### 11.1 日常维护
- [ ] 每周检查系统更新
- [ ] 每月检查SSL证书状态
- [ ] 每月检查磁盘空间使用
- [ ] 每月清理日志文件

### 11.2 维护命令
```bash
# 系统更新
sudo apt update && sudo apt upgrade -y

# 清理系统
sudo apt autoremove -y
sudo apt autoclean

# 检查磁盘使用
df -h
du -sh /var/log/*

# 清理旧日志
sudo journalctl --vacuum-time=30d
```

---

## 🎯 12. 性能优化

### 12.1 Nginx优化
```bash
# 编辑Nginx主配置
sudo nano /etc/nginx/nginx.conf

# 添加/修改以下配置：
worker_processes auto;
worker_connections 1024;

# 开启Gzip压缩
gzip on;
gzip_comp_level 6;
gzip_min_length 1000;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
```

### 12.2 系统优化
```bash
# 增加文件描述符限制
echo "deploy soft nofile 65536" | sudo tee -a /etc/security/limits.conf
echo "deploy hard nofile 65536" | sudo tee -a /etc/security/limits.conf
```

---

## 📞 13. 联系信息

**项目信息**
- 项目名称: 珠海优美化妆品官网
- 技术栈: Vue 3 + TypeScript + Vite
- 部署环境: Ubuntu 22.04 + Nginx

**技术支持**
- 如遇到部署问题，请检查日志文件
- 确保所有依赖都正确安装
- 检查防火墙和安全组配置

---

🎉 **部署完成！** 您的珠海优美化妆品官网现在应该可以通过 https://your-domain.com 访问了！
