# ç æµ·ä¼˜ç¾å®˜ç½‘ - é˜¿é‡Œäº‘Ubuntu 22.04éƒ¨ç½²æŒ‡å—

## ğŸ“‹ éƒ¨ç½²æ¦‚è§ˆ

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨åœ¨é˜¿é‡Œäº‘Ubuntu 22.04æœåŠ¡å™¨ä¸Šéƒ¨ç½²ç æµ·ä¼˜ç¾åŒ–å¦†å“å®˜ç½‘ï¼ˆVue 3 + TypeScript + Viteé¡¹ç›®ï¼‰ã€‚

### é¡¹ç›®æ¶æ„
- **å‰ç«¯**: Vue 3 + TypeScript + Vite
- **åŒ…ç®¡ç†å™¨**: Bun
- **WebæœåŠ¡å™¨**: Nginx
- **è¿›ç¨‹ç®¡ç†**: PM2
- **SSLè¯ä¹¦**: Let's Encrypt

---

## ğŸ›’ 1. é˜¿é‡Œäº‘æœåŠ¡å™¨è´­ä¹°ä¸é…ç½®

### 1.1 è´­ä¹°ECSå®ä¾‹
```bash
# æ¨èé…ç½®
- å®ä¾‹è§„æ ¼: ecs.t6-c1m2.large (2æ ¸4GB) æˆ–æ›´é«˜
- æ“ä½œç³»ç»Ÿ: Ubuntu 22.04 LTS
- å¸¦å®½: 5Mbps æˆ–æ›´é«˜
- å­˜å‚¨: 40GB SSD æˆ–æ›´é«˜
- å®‰å…¨ç»„: å¼€æ”¾ 22, 80, 443 ç«¯å£
```

### 1.2 åˆå§‹å®‰å…¨è®¾ç½®
```bash
# è¿æ¥æœåŠ¡å™¨
ssh root@your-server-ip

# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# åˆ›å»ºérootç”¨æˆ·
sudo adduser deploy
sudo usermod -aG sudo deploy

# é…ç½®SSHå¯†é’¥ç™»å½•ï¼ˆæ¨èï¼‰
# åœ¨æœ¬åœ°ç”Ÿæˆå¯†é’¥å¯¹
ssh-keygen -t rsa -b 4096 -C "your-email@example.com"

# å¤åˆ¶å…¬é’¥åˆ°æœåŠ¡å™¨
ssh-copy-id deploy@your-server-ip
```

---

## ğŸ”§ 2. æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

### 2.1 å®‰è£…åŸºç¡€å·¥å…·
```bash
# åˆ‡æ¢åˆ°deployç”¨æˆ·
su - deploy

# å®‰è£…å¿…è¦å·¥å…·
sudo apt install -y curl wget git unzip build-essential

# å®‰è£… Node.js (ä½¿ç”¨NodeSourceä»“åº“)
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# éªŒè¯å®‰è£…
node --version  # åº”è¯¥æ˜¾ç¤º v20.x.x
npm --version
```

### 2.2 å®‰è£…Bun
```bash
# å®‰è£…BunåŒ…ç®¡ç†å™¨
curl -fsSL https://bun.sh/install | bash

# é‡æ–°åŠ è½½shellé…ç½®
source ~/.bashrc

# éªŒè¯å®‰è£…
bun --version
```

### 2.3 å®‰è£…Nginx
```bash
# å®‰è£…Nginx
sudo apt install -y nginx

# å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl start nginx
sudo systemctl enable nginx

# æ£€æŸ¥çŠ¶æ€
sudo systemctl status nginx
```

### 2.4 å®‰è£…PM2è¿›ç¨‹ç®¡ç†å™¨
```bash
# å…¨å±€å®‰è£…PM2
sudo npm install -g pm2

# è®¾ç½®PM2å¼€æœºè‡ªå¯
pm2 startup
sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u deploy --hp /home/deploy
```

---

## ğŸ“¦ 3. é¡¹ç›®éƒ¨ç½²

### 3.1 åˆ›å»ºé¡¹ç›®ç›®å½•
```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
sudo mkdir -p /var/www/zhuhai-youmei
sudo chown -R deploy:deploy /var/www/zhuhai-youmei
cd /var/www/zhuhai-youmei
```

### 3.2 ä¸Šä¼ é¡¹ç›®æ–‡ä»¶

#### æ–¹æ³•1: ä½¿ç”¨Gitï¼ˆæ¨èï¼‰
```bash
# å¦‚æœæœ‰Gitä»“åº“
git clone https://github.com/your-username/msd-style-cosmetics.git .
cd frontend
```

#### æ–¹æ³•2: ä½¿ç”¨SCPä¸Šä¼ 
```bash
# åœ¨æœ¬åœ°æ‰§è¡Œï¼ˆæ‰“åŒ…é¡¹ç›®ï¼‰
cd msd-style-cosmetics/frontend
tar -czf project.tar.gz .

# ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp project.tar.gz deploy@your-server-ip:/var/www/zhuhai-youmei/

# åœ¨æœåŠ¡å™¨è§£å‹
cd /var/www/zhuhai-youmei
tar -xzf project.tar.gz
rm project.tar.gz
```

### 3.3 å®‰è£…ä¾èµ–å’Œæ„å»º
```bash
cd /var/www/zhuhai-youmei

# å®‰è£…é¡¹ç›®ä¾èµ–
bun install

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
bun run build

# æ£€æŸ¥æ„å»ºç»“æœ
ls -la dist/
```

---

## ğŸŒ 4. Nginxé…ç½®

### 4.1 åˆ›å»ºç«™ç‚¹é…ç½®
```bash
# åˆ›å»ºNginxé…ç½®æ–‡ä»¶
sudo nano /etc/nginx/sites-available/zhuhai-youmei
```

### 4.2 Nginxé…ç½®å†…å®¹
```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    # é‡å®šå‘åˆ°HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    # SSLé…ç½®ï¼ˆç¨åé…ç½®è¯ä¹¦ï¼‰
    # ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # å®‰å…¨headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

    # ç½‘ç«™æ ¹ç›®å½•
    root /var/www/zhuhai-youmei/dist;
    index index.html;

    # å¤„ç†Vue Routerçš„historyæ¨¡å¼
    location / {
        try_files $uri $uri/ /index.html;
    }

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # å‹ç¼©é…ç½®
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss;
}
```

### 4.3 å¯ç”¨ç«™ç‚¹é…ç½®
```bash
# åˆ›å»ºè½¯é“¾æ¥å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/zhuhai-youmei /etc/nginx/sites-enabled/

# åˆ é™¤é»˜è®¤é…ç½®
sudo rm /etc/nginx/sites-enabled/default

# æµ‹è¯•Nginxé…ç½®
sudo nginx -t

# é‡å¯Nginx
sudo systemctl restart nginx
```

---

## ğŸ”’ 5. SSLè¯ä¹¦é…ç½®

### 5.1 å®‰è£…Certbot
```bash
# å®‰è£…Certbot
sudo apt install -y certbot python3-certbot-nginx

# è·å–SSLè¯ä¹¦
sudo certbot --nginx -d your-domain.com -d www.your-domain.com
```

### 5.2 æ›´æ–°Nginxé…ç½®
```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œå–æ¶ˆSSLé…ç½®çš„æ³¨é‡Š
sudo nano /etc/nginx/sites-available/zhuhai-youmei

# é‡å¯Nginx
sudo systemctl restart nginx
```

### 5.3 è®¾ç½®è¯ä¹¦è‡ªåŠ¨ç»­æœŸ
```bash
# æµ‹è¯•è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run

# æ·»åŠ cronä»»åŠ¡
sudo crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯æœˆ1å·å‡Œæ™¨2ç‚¹æ£€æŸ¥ç»­æœŸï¼‰
0 2 1 * * /usr/bin/certbot renew --quiet && /usr/bin/systemctl reload nginx
```

---

## ğŸš€ 6. PM2è¿›ç¨‹ç®¡ç†ï¼ˆå¯é€‰ - å¦‚æœéœ€è¦SSRï¼‰

### 6.1 åˆ›å»ºPM2é…ç½®æ–‡ä»¶
```bash
cd /var/www/zhuhai-youmei
nano ecosystem.config.js
```

```javascript
module.exports = {
  apps: [{
    name: 'zhuhai-youmei',
    script: 'bun',
    args: 'run preview --host 0.0.0.0 --port 3000',
    cwd: '/var/www/zhuhai-youmei',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production'
    }
  }]
}
```

### 6.2 å¯åŠ¨PM2
```bash
# å¯åŠ¨åº”ç”¨
pm2 start ecosystem.config.js

# ä¿å­˜PM2é…ç½®
pm2 save

# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
pm2 status
pm2 logs
```

---

## ğŸ”¥ 7. é˜²ç«å¢™é…ç½®

### 7.1 é…ç½®UFWé˜²ç«å¢™
```bash
# å¯ç”¨UFW
sudo ufw enable

# å…è®¸SSH
sudo ufw allow ssh

# å…è®¸HTTPå’ŒHTTPS
sudo ufw allow 'Nginx Full'

# æŸ¥çœ‹çŠ¶æ€
sudo ufw status
```

### 7.2 é˜¿é‡Œäº‘å®‰å…¨ç»„é…ç½®
```bash
# åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°é…ç½®å®‰å…¨ç»„è§„åˆ™ï¼š
# - å…¥æ–¹å‘ï¼šå…è®¸ 22/TCP (SSH)
# - å…¥æ–¹å‘ï¼šå…è®¸ 80/TCP (HTTP)
# - å…¥æ–¹å‘ï¼šå…è®¸ 443/TCP (HTTPS)
# - å‡ºæ–¹å‘ï¼šå…è®¸å…¨éƒ¨
```

---

## ğŸ“Š 8. ç›‘æ§å’Œæ—¥å¿—

### 8.1 ç³»ç»Ÿç›‘æ§
```bash
# å®‰è£…htop
sudo apt install -y htop

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
htop
df -h
free -h
```

### 8.2 æ—¥å¿—ç®¡ç†
```bash
# Nginxæ—¥å¿—ä½ç½®
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# ç³»ç»Ÿæ—¥å¿—
sudo journalctl -u nginx -f
```

### 8.3 è®¾ç½®æ—¥å¿—è½®è½¬
```bash
# ç¼–è¾‘logrotateé…ç½®
sudo nano /etc/logrotate.d/nginx

# ç¡®ä¿åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
/var/log/nginx/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        systemctl reload nginx
    endscript
}
```

---

## ğŸ”„ 9. éƒ¨ç½²è‡ªåŠ¨åŒ–è„šæœ¬

### 9.1 åˆ›å»ºéƒ¨ç½²è„šæœ¬
```bash
nano /home/deploy/deploy.sh
```

```bash
#!/bin/bash

echo "ğŸš€ å¼€å§‹éƒ¨ç½²ç æµ·ä¼˜ç¾å®˜ç½‘..."

# é¡¹ç›®ç›®å½•
PROJECT_DIR="/var/www/zhuhai-youmei"

# åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
cd $PROJECT_DIR

# æ‹‰å–æœ€æ–°ä»£ç ï¼ˆå¦‚æœä½¿ç”¨Gitï¼‰
echo "ğŸ“¦ æ›´æ–°ä»£ç ..."
git pull origin main

# å®‰è£…ä¾èµ–
echo "ğŸ“‹ å®‰è£…ä¾èµ–..."
bun install

# æ„å»ºé¡¹ç›®
echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
bun run build

# é‡å¯Nginx
echo "ğŸ”„ é‡å¯Nginx..."
sudo systemctl restart nginx

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "âœ… æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
sudo systemctl status nginx --no-pager

echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
echo "ğŸŒ ç½‘ç«™åœ°å€: https://your-domain.com"
```

### 9.2 è®¾ç½®è„šæœ¬æƒé™
```bash
chmod +x /home/deploy/deploy.sh

# è¿è¡Œéƒ¨ç½²
./deploy.sh
```

---

## ğŸ› ï¸ 10. å¸¸è§é—®é¢˜è§£å†³

### 10.1 æƒé™é—®é¢˜
```bash
# ä¿®å¤æ–‡ä»¶æƒé™
sudo chown -R deploy:deploy /var/www/zhuhai-youmei
sudo chmod -R 755 /var/www/zhuhai-youmei
```

### 10.2 Nginxå¯åŠ¨å¤±è´¥
```bash
# æ£€æŸ¥é…ç½®è¯­æ³•
sudo nginx -t

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
sudo journalctl -u nginx --no-pager
```

### 10.3 SSLè¯ä¹¦é—®é¢˜
```bash
# æ‰‹åŠ¨ç»­æœŸè¯ä¹¦
sudo certbot renew

# æ£€æŸ¥è¯ä¹¦çŠ¶æ€
sudo certbot certificates
```

### 10.4 ç«¯å£å ç”¨
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
sudo netstat -tulpn | grep :80
sudo netstat -tulpn | grep :443

# æ€æ­»å ç”¨ç«¯å£çš„è¿›ç¨‹
sudo pkill -f nginx
```

---

## ğŸ“‹ 11. ç»´æŠ¤æ¸…å•

### 11.1 æ—¥å¸¸ç»´æŠ¤
- [ ] æ¯å‘¨æ£€æŸ¥ç³»ç»Ÿæ›´æ–°
- [ ] æ¯æœˆæ£€æŸ¥SSLè¯ä¹¦çŠ¶æ€
- [ ] æ¯æœˆæ£€æŸ¥ç£ç›˜ç©ºé—´ä½¿ç”¨
- [ ] æ¯æœˆæ¸…ç†æ—¥å¿—æ–‡ä»¶

### 11.2 ç»´æŠ¤å‘½ä»¤
```bash
# ç³»ç»Ÿæ›´æ–°
sudo apt update && sudo apt upgrade -y

# æ¸…ç†ç³»ç»Ÿ
sudo apt autoremove -y
sudo apt autoclean

# æ£€æŸ¥ç£ç›˜ä½¿ç”¨
df -h
du -sh /var/log/*

# æ¸…ç†æ—§æ—¥å¿—
sudo journalctl --vacuum-time=30d
```

---

## ğŸ¯ 12. æ€§èƒ½ä¼˜åŒ–

### 12.1 Nginxä¼˜åŒ–
```bash
# ç¼–è¾‘Nginxä¸»é…ç½®
sudo nano /etc/nginx/nginx.conf

# æ·»åŠ /ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š
worker_processes auto;
worker_connections 1024;

# å¼€å¯Gzipå‹ç¼©
gzip on;
gzip_comp_level 6;
gzip_min_length 1000;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
```

### 12.2 ç³»ç»Ÿä¼˜åŒ–
```bash
# å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
echo "deploy soft nofile 65536" | sudo tee -a /etc/security/limits.conf
echo "deploy hard nofile 65536" | sudo tee -a /etc/security/limits.conf
```

---

## ğŸ“ 13. è”ç³»ä¿¡æ¯

**é¡¹ç›®ä¿¡æ¯**
- é¡¹ç›®åç§°: ç æµ·ä¼˜ç¾åŒ–å¦†å“å®˜ç½‘
- æŠ€æœ¯æ ˆ: Vue 3 + TypeScript + Vite
- éƒ¨ç½²ç¯å¢ƒ: Ubuntu 22.04 + Nginx

**æŠ€æœ¯æ”¯æŒ**
- å¦‚é‡åˆ°éƒ¨ç½²é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
- ç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½æ­£ç¡®å®‰è£…
- æ£€æŸ¥é˜²ç«å¢™å’Œå®‰å…¨ç»„é…ç½®

---

ğŸ‰ **éƒ¨ç½²å®Œæˆï¼** æ‚¨çš„ç æµ·ä¼˜ç¾åŒ–å¦†å“å®˜ç½‘ç°åœ¨åº”è¯¥å¯ä»¥é€šè¿‡ https://your-domain.com è®¿é—®äº†ï¼
